name: Multi-Agent Workflow Orchestrator

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
      agent:
        description: 'Agent to execute (PO, DEV, QA, or ALL)'
        required: true
        default: 'ALL'

permissions:
  issues: write
  contents: read
  pull-requests: write
  repository-projects: write

jobs:
  # Add issue to project board
  add-to-project:
    name: ğŸ“‹ Add to Project Board
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    
    steps:
      - name: Add issue to project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: ${{ vars.PROJECT_URL }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
  
  # ALL Agents - Executes all agents sequentially in a single job
  all-agents:
    name: ğŸš€ ALL Agents - Complete Workflow
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/agent all')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.agent == 'ALL')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup GitHub CLI
        run: |
          gh --version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Execute ALL Agents
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          agent-role: 'ALL'
          issue-number: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          copilot-enabled: 'true'
      
      - name: Post Completion Summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number || (context.payload.inputs && context.payload.inputs.issue_number);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `## ğŸš€ All Agents Executed Successfully!
              
              All three agents have been applied to this issue:
              - âœ… ğŸ¯ **PO Agent**: User Stories, BDD Scenarios, and Acceptance Criteria
              - âœ… ğŸ’» **DEV Agent**: Implementation Plan, Unit Tests, and Documentation
              - âœ… ğŸ§ª **QA Agent**: Test Cases and QA Plan
              
              The issue is now fully prepared for development! ğŸ‰
              
              ---
              *Powered by Blueprint AI with GitHub Copilot integration*`
            });
        continue-on-error: true
  
  # Product Owner Agent
  po-agent:
    name: ğŸ¯ PO Agent - User Stories & BDD
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/agent po') && !contains(github.event.comment.body, '/agent all')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.agent == 'PO')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup GitHub CLI
        run: |
          gh --version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Execute PO Agent
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          agent-role: 'PO'
          issue-number: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          copilot-enabled: 'true'
      
      - name: Update Project Status to Ready
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Comment to indicate project board update
            const issue_number = context.issue.number || context.payload.inputs.issue_number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: 'ğŸ“‹ **Project Board Update**: Issue moved to "Ready" status with `agent:po` label.'
            });
        continue-on-error: true
  
  # Developer Agent
  dev-agent:
    name: ğŸ’» DEV Agent - Implementation & Tests
    runs-on: ubuntu-latest
    needs: po-agent
    if: |
      always() &&
      (needs.po-agent.result == 'success' || needs.po-agent.result == 'skipped') &&
      ((github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'agent:po')) ||
       (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/agent dev') && !contains(github.event.comment.body, '/agent all')) ||
       (github.event_name == 'workflow_dispatch' && github.event.inputs.agent == 'DEV'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup GitHub CLI
        run: |
          gh --version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Execute DEV Agent
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          agent-role: 'DEV'
          issue-number: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          copilot-enabled: 'true'
      
      - name: Update Project Status to In Progress
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Comment to indicate project board update
            const issue_number = context.issue.number || context.payload.inputs.issue_number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: 'ğŸ“‹ **Project Board Update**: Issue moved to "In Progress" status with `agent:dev` label.'
            });
        continue-on-error: true
  
  # QA Agent
  qa-agent:
    name: ğŸ§ª QA Agent - Test Cases
    runs-on: ubuntu-latest
    needs: dev-agent
    if: |
      always() &&
      (needs.dev-agent.result == 'success' || needs.dev-agent.result == 'skipped') &&
      ((github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'agent:dev')) ||
       (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/agent qa') && !contains(github.event.comment.body, '/agent all')) ||
       (github.event_name == 'workflow_dispatch' && github.event.inputs.agent == 'QA'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup GitHub CLI
        run: |
          gh --version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Execute QA Agent
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          agent-role: 'QA'
          issue-number: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          copilot-enabled: 'true'
      
      - name: Update Project Status to Testing
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Comment to indicate project board update
            const issue_number = context.issue.number || context.payload.inputs.issue_number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: 'ğŸ“‹ **Project Board Update**: Issue moved to "Testing" status with `agent:qa` label.'
            });
        continue-on-error: true
  
  # Summary Job
  workflow-summary:
    name: ğŸ“Š Workflow Summary
    runs-on: ubuntu-latest
    needs: [po-agent, dev-agent, qa-agent]
    if: always()
    
    steps:
      - name: Post Summary Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number || context.payload.inputs.issue_number;
            const po_result = '${{ needs.po-agent.result }}';
            const dev_result = '${{ needs.dev-agent.result }}';
            const qa_result = '${{ needs.qa-agent.result }}';
            
            const getEmoji = (result) => {
              if (result === 'success') return 'âœ…';
              if (result === 'failure') return 'âŒ';
              if (result === 'skipped') return 'â­ï¸';
              return 'â¬œ';
            };
            
            const summary = `
            ## ğŸ¤– Multi-Agent Workflow Summary
            
            | Agent | Status | Description |
            |-------|--------|-------------|
            | ğŸ¯ PO Agent | ${getEmoji(po_result)} ${po_result} | User Stories, BDD, Acceptance Criteria |
            | ğŸ’» DEV Agent | ${getEmoji(dev_result)} ${dev_result} | Implementation Plan, Unit Tests, Documentation |
            | ğŸ§ª QA Agent | ${getEmoji(qa_result)} ${qa_result} | Test Cases, QA Plan |
            
            ---
            
            ### ğŸš€ Next Steps
            
            ${po_result === 'success' ? '- âœ… PO Agent has added user stories and acceptance criteria\n' : ''}
            ${dev_result === 'success' ? '- âœ… DEV Agent has added implementation plan and test structure\n' : ''}
            ${qa_result === 'success' ? '- âœ… QA Agent has added test cases and QA plan\n' : ''}
            
            ### ğŸ’¡ Commands
            
            You can manually trigger individual agents by commenting:
            - \`/agent po\` - Run PO Agent
            - \`/agent dev\` - Run DEV Agent  
            - \`/agent qa\` - Run QA Agent
            - \`/agent all\` - Run ALL Agents (PO â†’ DEV â†’ QA)
            
            ---
            
            *Powered by Blueprint AI with GitHub Copilot integration*
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: summary
            });
